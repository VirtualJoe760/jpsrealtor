# Current Issue: Article Generation Failing on Production

**Date**: 2026-01-22
**Status**: ✅ RESOLVED
**Priority**: HIGH - Blocking blog post creation on live site

## ✅ RESOLUTION (2026-01-22)

### Root Cause Identified
The issue was NOT related to keywords at all! The actual problem was:

**`/api/articles/generate` endpoint was restricted to admins only, but agents need access to generate articles.**

### The Fix
Updated `src/app/api/articles/generate/route.ts` line 16-22:

**Before:**
```typescript
if (!session?.user?.isAdmin) {
  return NextResponse.json(
    { error: 'Unauthorized. Admin access required.' },
    { status: 403 }
  );
}
```

**After:**
```typescript
// Allow both admins and authenticated agents to generate articles
if (!session?.user) {
  return NextResponse.json(
    { error: 'Unauthorized. Please sign in.' },
    { status: 401 }
  );
}
```

### Why This Was the Issue
According to `AGENT_CRM_CMS_SCOPING.md`, the CMS scoping was "100% Complete" and agents should be able to publish articles directly. The `/api/articles/publish` endpoint was correctly updated to allow agents, but the `/api/articles/generate` endpoint was missed and still required admin access.

### Deployment
- Commit: Fix article generation access for agents
- Branch: crm
- Merged to: main
- Status: Deployed to production

---

## Original Issue Investigation (For Reference)

---

## Problem Summary

Article generation is failing on the production deployment (jpsrealtor.com). The AI generation endpoint (`/api/articles/generate`) is not completing successfully, preventing users from creating new blog posts.

### Symptoms

1. **No detailed error logs visible** - Only NextAuth debug warning showing in Vercel logs
2. **400 Bad Request** response when attempting to generate articles
3. **No server-side logs appearing** despite comprehensive logging added

### Recent Changes That May Be Related

#### 1. Keywords Field Modification (Commit: d5de9a22)
- **What changed**: Removed keywords input from AI generation form (pre-generation)
- **Why**: User reported it was causing errors during blog generation
- **Current state**: Keywords field still exists in SEO metadata section (post-generation)
- **Potential issue**: Mismatch between what frontend sends vs. what backend expects

#### 2. Article Model Slug Validation (Commit: 38d2ba77)
- **What changed**: Removed `required: true` from slug field in Article model
- **Why**: Slug is auto-generated by pre-save hook, but Mongoose validates before hooks run
- **Fix applied**: Slug now auto-generates without validation error
- **Status**: ✅ This should be working correctly now

#### 3. Duplicate Index Warning (Commit: 38d2ba77)
- **What changed**: Removed redundant slug index definition
- **Why**: Slug had both `unique: true` in schema AND separate index
- **Status**: ✅ Fixed, warning should be gone

---

## Technical Details

### API Endpoint
```
POST /api/articles/generate
```

### Expected Request Body
```typescript
{
  topic: string;        // Required
  category: string;     // Required ("articles" | "market-insights" | "real-estate-tips")
  keywords?: string[];  // Optional (was removed from generation form)
  tone?: string;        // Optional
  length?: string;      // Optional
}
```

### Expected Response
```typescript
{
  success: true,
  article: {
    title: string;
    slugId: string;
    excerpt: string;
    content: string;
    category: string;
    tags: string[];
    featuredImage: {
      url: string;
      publicId: string;
      alt: string;
    },
    seo: {
      title: string;
      description: string;
      keywords: string[];  // Should always be an array
    }
  },
  warnings?: string[];
}
```

---

## Files Involved

### Frontend
- **`src/app/agent/cms/new/page.tsx`** - Article creation form
  - Line 100-105: Generation API call (no longer sends keywords)
  - Line 68-69: SEO keywords in formData state
  - Line 137: Loading keywords from generated article
  - Lines 863-923: Keywords UI in SEO section

### Backend
- **`src/app/api/articles/generate/route.ts`** - AI generation endpoint
  - Line 27: Destructures keywords from request body
  - Line 65-69: Keywords defined in AI tool schema (still required by AI)
  - Line 168: Keywords used in prompt (if provided)
  - Line 289: Keywords fallback `|| []` added
  - Lines 12-37, 241-267, 293-317: Comprehensive logging added

- **`src/models/article.ts`** - MongoDB Article schema
  - Line 82-87: Slug field (required removed)
  - Line 177-180: Keywords field in SEO object
  - Line 246-252: Pre-save hook for slug generation

### Libraries
- **`src/lib/article-digester.ts`** - Validates and processes AI responses
- **`src/lib/groq.ts`** - Groq AI integration

---

## Debugging Steps Completed

### ✅ Step 1: Remove Keywords Input from Generation Form
- Removed the pre-generation keywords input field
- Kept keywords in SEO metadata section for manual entry
- **Commit**: d5de9a22

### ✅ Step 2: Fix Slug Validation Error
- Removed `required: true` from slug field
- Slug still auto-generates and is unique
- **Commit**: 38d2ba77

### ✅ Step 3: Fix Duplicate Index Warning
- Removed redundant slug index
- **Commit**: 38d2ba77

### ✅ Step 4: Add Comprehensive Logging
- Added logging at every critical point in generation API
- Logs request body, AI response, digested data, final structure
- Added error stack traces
- **Commit**: 213d68ea

---

## Next Steps for Debugging

### 1. Check Vercel Logs
After the latest deployment (213d68ea), attempt to generate an article and check Vercel logs for:

```
[Article Generation] Starting article generation...
[Article Generation] Request body: {...}
[Article Generation] Validated input: {...}
[Article Generation] Raw AI response: {...}
[Article Generation] Digested article data: {...}
[Article Generation] Final article structure: {...}
[Article Generation] Article generation completed successfully
```

**If logs don't appear**: The request isn't reaching the API endpoint (frontend issue)

**If logs stop at a specific point**: That's where the error is occurring

### 2. Frontend Request Inspection
Check what the frontend is actually sending:

**File**: `src/app/agent/cms/new/page.tsx`
**Function**: `handleGenerate()` around line 96-152

```typescript
const response = await fetch("/api/articles/generate", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    topic: generationTopic,
    category: formData.category,
    tone: "professional yet approachable",
    length: "comprehensive",
  }),
});
```

**Verify**:
- Is `generationTopic` populated?
- Is `formData.category` valid?
- Are keywords being sent (they shouldn't be)?

### 3. Check for Keyword Mismatch Issues

**Hypothesis**: The AI still expects keywords in the tool schema, but we're not providing them

**File to check**: `src/app/api/articles/generate/route.ts`

Line 65-71 shows keywords are **required** by the AI tool:
```typescript
keywords: {
  type: "array",
  items: { type: "string" },
  description: "5-10 SEO keywords..."
}
```

Line 71: `required: ["title", "excerpt", "content", "altText", "metaTitle", "metaDescription", "keywords"]`

**Potential fix**: If we're not sending keywords to AI, we might need to:
1. Make keywords optional in the tool schema
2. OR always send empty array from frontend
3. OR let AI generate keywords without our input

### 4. Check Article Digester

**File**: `src/lib/article-digester.ts`

This validates the AI response. Check if it's rejecting articles due to missing/invalid keywords.

---

## Rollback Plan (If Needed)

If we can't resolve quickly, we can rollback the keywords changes:

```bash
# Rollback to before keywords removal
git revert d5de9a22

# Or cherry-pick specific fixes
git cherry-pick 38d2ba77  # Keep slug fix
git cherry-pick 213d68ea  # Keep logging
```

---

## Reference Documentation

### Groq AI Tool Calling
- [Groq Tool Use Documentation](https://console.groq.com/docs/tool-use)
- Our implementation: `src/lib/groq.ts`

### Mongoose Schema & Hooks
- [Mongoose Pre-save Hooks](https://mongoosejs.com/docs/middleware.html#pre)
- [Mongoose Validation](https://mongoosejs.com/docs/validation.html)
- Our model: `src/models/article.ts`

### Next.js API Routes
- [Next.js Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
- Our route: `src/app/api/articles/generate/route.ts`

---

## Contact & Session Info

**Last worked on**: 2026-01-22
**Branch**: `crm` (synced with `main`)
**Last commit**: 213d68ea (Add comprehensive logging)
**Deployment**: Vercel auto-deploys from `main` branch

---

## Quick Commands

```bash
# Check logs in Vercel
# Go to: https://vercel.com → jpsrealtor → Logs

# View recent commits
git log --oneline -10

# Check current changes
git status

# Test locally
npm run dev
# Then visit: http://localhost:3000/agent/cms/new

# Push fixes
git add -A
git commit -m "Fix: [description]"
git push origin crm
git checkout main && git merge crm && git push origin main && git checkout crm
```

---

## Expected Behavior (When Working)

1. User visits `/agent/cms/new`
2. User fills in:
   - Topic: "Mortgage Rates Dropping Below 6%"
   - Category: "Market Insights"
   - (No keywords input shown before generation)
3. User clicks "Generate Article"
4. Frontend sends POST to `/api/articles/generate`
5. Backend calls Groq AI with topic + category
6. AI generates article WITH keywords (5-10 SEO keywords)
7. Backend validates and digests response
8. Backend returns article to frontend
9. Frontend populates form fields
10. User can now manually add/edit keywords in SEO section
11. User uploads image, reviews, and publishes

**Current State**: Failing somewhere between steps 4-8
